---
import LayoutDefault from '~/layouts/LayoutDefault.astro'
import EssayCard from '~/components/EssayCard.astro'
import { getEssays } from '~/utils'
import '~/styles/essay-timeline.css'

const allEssays = await getEssays()

// Build month map for clock dial navigation
type MonthEntry = { year: number; month: number; label: string; key: string; firstIndex: number }
const monthMap: MonthEntry[] = []
const seen = new Set<string>()
allEssays.forEach((essay, index) => {
  const d = new Date(essay.data.pubDate)
  const year = d.getFullYear()
  const month = d.getMonth() + 1
  const key = `${year}-${String(month).padStart(2, '0')}`
  if (!seen.has(key)) {
    seen.add(key)
    monthMap.push({ year, month, label: `${month}月`, key, firstIndex: index })
  }
})

function getEssayMonthKey(pubDate: Date | string) {
  const d = new Date(pubDate)
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`
}
---

<LayoutDefault>
  <div class="essays-page-wrapper">
    <nav id="clock-dial" class="clock-dial" aria-label="月份导航">
      <div class="clock-dial__track">
        {monthMap.map((item, i) => {
          const showYear = i === 0 || monthMap[i - 1].year !== item.year
          return (
            <Fragment>
              {showYear && <div class="clock-dial__year-label">{item.year}</div>}
              <button
                class="clock-dial__tick"
                data-month-index={item.firstIndex}
                data-month-key={item.key}
                type="button"
              >
                {item.label}
              </button>
            </Fragment>
          )
        })}
        <div id="clock-dial-indicator" class="clock-dial__indicator"></div>
      </div>
    </nav>

    <section un-flex="~ col">
      {
        allEssays.map(async (essay, index) => {
          const { Content } = await essay.render()
          return (
            <div
              class="essay-item"
              data-essay-index={index}
              data-essay-month={getEssayMonthKey(essay.data.pubDate)}
            >
              <EssayCard essay={essay}>
                <div class="prose prose-invert [&>p]:mb-0 [&>*]:text-gray-300 [&>*:last-child]:mb-0">
                  <Content />
                </div>
              </EssayCard>
            </div>
          )
        })
      }
    </section>
  </div>
</LayoutDefault>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const allItems = document.querySelectorAll<HTMLElement>('[data-essay-index]')
    if (allItems.length === 0) return

    let monthObserver: IntersectionObserver | null = null
    let settleTimer: number | null = null
    let activeScrollId = 0

    // --- Clock dial navigation ---
    const dial = document.getElementById('clock-dial')
    if (!dial) return

    const ticks = dial.querySelectorAll<HTMLButtonElement>('.clock-dial__tick')
    const indicator = document.getElementById('clock-dial-indicator')
    let activeTick: HTMLButtonElement | null = ticks.length > 0 ? ticks[0] : null
    let isClickScrolling = false

    // Set initial active tick
    if (activeTick) {
      activeTick.classList.add('clock-dial__tick--active')
      updateIndicator(activeTick)
    }

    function setActiveTick(tick: HTMLButtonElement) {
      if (activeTick) activeTick.classList.remove('clock-dial__tick--active')
      tick.classList.add('clock-dial__tick--active')
      activeTick = tick
      updateIndicator(tick)
    }

    function updateIndicator(tick: HTMLButtonElement | null) {
      if (!indicator || !tick) return
      const y = tick.offsetTop + tick.offsetHeight / 2 - 3.5
      indicator.style.transform = 'translateY(' + y + 'px)'
    }

    function clearSettleTimer() {
      if (settleTimer !== null) {
        window.clearTimeout(settleTimer)
        settleTimer = null
      }
    }

    function getExpectedTop(target: HTMLElement) {
      const raw = window.getComputedStyle(target).scrollMarginTop || '0'
      const px = Number.parseFloat(raw)
      return Number.isFinite(px) ? px : 0
    }

    function scrollToTargetWithSettle(target: HTMLElement) {
      clearSettleTimer()
      activeScrollId += 1
      const scrollId = activeScrollId
      const startedAt = performance.now()
      const maxDuration = 2600
      const settleDelay = 280
      const settleInterval = 120
      const tolerance = 8

      isClickScrolling = true
      requestAnimationFrame(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' })
      })

      const settle = () => {
        if (scrollId !== activeScrollId) return

        const expectedTop = getExpectedTop(target)
        const currentTop = target.getBoundingClientRect().top
        const distance = Math.abs(currentTop - expectedTop)
        const elapsed = performance.now() - startedAt

        if (distance <= tolerance || elapsed > maxDuration) {
          isClickScrolling = false
          settleTimer = null
          return
        }

        target.scrollIntoView({ behavior: 'auto', block: 'start' })
        settleTimer = window.setTimeout(settle, settleInterval)
      }

      settleTimer = window.setTimeout(settle, settleDelay)
    }

    // --- Click handlers ---
    ticks.forEach((tick) => {
      tick.addEventListener('click', () => {
        const targetIndex = Number.parseInt(tick.dataset.monthIndex || '0', 10)
        setActiveTick(tick)

        const target = allItems[targetIndex]
        if (target) {
          scrollToTargetWithSettle(target)
        }
      })
    })

    // --- Scroll sync ---
    monthObserver = new IntersectionObserver(
      (entries) => {
        if (isClickScrolling) return
        let topEntry = null
        for (const entry of entries) {
          if (entry.isIntersecting) {
            if (!topEntry || entry.boundingClientRect.top < topEntry.boundingClientRect.top) {
              topEntry = entry
            }
          }
        }
        if (topEntry) {
          const monthKey = (topEntry.target as HTMLElement).dataset.essayMonth
          if (monthKey) {
            const matchTick = dial.querySelector<HTMLButtonElement>('[data-month-key="' + monthKey + '"]')
            if (matchTick && matchTick !== activeTick) {
              setActiveTick(matchTick)
            }
          }
        }
      },
      { rootMargin: '-10% 0px -80% 0px' }
    )

    // Observe essays for month sync
    allItems.forEach((item) => {
      monthObserver?.observe(item)
    })

  })
</script>
